var aliasMap = {};
module.exports.map = function(app, configFile, routePath) {
  var controllers_init;
  var controllers;
  var routeDir = '../../../routes/';
  var config = require(routeDir + configFile);
  // Register all routes with appopreate callback
  for(var i = 0; i < config.length; i++) {
    var map = config[i];
    // Register each resource to a route
    if(map.resource) { // Unnested resource: users, session...
      var resource = map.resource;
      if(resource.indexOf('#') == -1) {
        var routeFileName = resource;

        controllers = require(routePath ? routeDir + routePath + '/' + routeFileName : routeDir + routeFileName);

        // Register index action: list all resource
        if(controllers['index']) {
          var action = controllers['index'];
          var filters = action.filters;
          if(filters) {
            if(typeof filters == 'function') { // one filter
              app.get('/' + resource, filters, action.callback);
            } else {
              filters.push(action.callback);
              filters.unshift('/' + resource);
              app.get.apply(app, filters);
              // Remember to append 'scope' before 'filters'
              action.filters = filters.slice(1, filters.length - 1);
            }
          } else { // No filterss
            app.get('/' + resource, action.callback);
          }
        }

        // Register show action: display resource information
        if(controllers['show']) {
          var action = controllers['show']
          if(action.param) {
            var filters = action.filters
            if(filters) { // apply filter(s)
              if(typeof filters == 'function') {
                app.get('/' + resource + '/' + action.param, filters, action.callback);
              } else {
                filters.push(action.callback);
                filters.unshift('/' + resource + '/' + action.param);
                app.get.apply(app, filters);
                // Remember to append 'scope' before 'filters'
                action.filters = filters.slice(1, filters.length - 1);
              }
            } else { // No filters
              app.get('/' + resource + '/' + action.param, action.callback);
            }
          }
        }


        // Register show action: display resource information
        if(controllers['new']) {
          var action = controllers['new'],
            filters = action.filters;

          if(filters) { // apply filter(s)
            if(typeof filters == 'function') {
              app.get('/' + resource + '/new', filters, action.callback);
            } else {
              filters.push(action.callback);
              filters.unshift('/' + resource + '/new');
              app.get.apply(app, filters);
              // Remember to append 'scope' before 'filters'
              action.filters = filters.slice(1, filters.length - 1);
            }
          } else { // No filters
            app.get('/' + resource + '/new', action.callback);
          }
        }


        // Register show action: display resource information
        if(controllers['edit']) {
          var action = controllers['edit']
          if(action.param) {
            var filters = action.filters
            if(filters) { // apply filter(s)
              if(typeof filters == 'function') {
                app.get('/' + resource + '/' + action.param + '/edit', filters, action.callback);
              } else {
                filters.push(action.callback);
                filters.unshift('/' + resource + '/' + action.param + '/edit');
                app.get.apply(app, filters);
                // Remember to append 'scope' before 'filters'
                action.filters = filters.slice(1, filters.length - 1);
              }
            } else { // No filters
              app.get('/' + resource + '/' + action.param + '/edit', action.callback);
            }
          }
        }


        // Register show action: display resource information
        if(controllers['create']) {
          var action = controllers['create'],
            filters = action.filters
          if(filters) { // apply filter(s)
            if(typeof filters == 'function') {
              app.post('/' + resource, filters, action.callback);
            } else {
              filters.push(action.callback);
              filters.unshift('/' + resource);
              app.post.apply(app, filters);
              // Remember to append 'scope' before 'filters'
              action.filters = filters.slice(1, filters.length - 1);
            }
          } else { // No filters
            app.post('/' + resource, action.callback);
          }
        }

        // Register show action: display resource information
        if(controllers['update']) {
          var action = controllers['update']
          if(action.param) {
            var filters = action.filters
            if(filters) { // apply filter(s)
              if(typeof filters == 'function') {
                app.put('/' + resource + '/' + action.param, filters, action.callback);
              } else {
                filters.push(action.callback);
                filters.unshift('/' + resource + '/' + action.param);
                app.put.apply(app, filters);
                // Remember to append 'scope' before 'filters'
                action.filters = filters.slice(1, filters.length - 1);
              }
            } else { // No filters
              app.put('/' + resource + '/' + action.param, action.callback);
            }
          }
        }

        // Register show action: display resource information
        if(controllers['delete']) {
          var action = controllers['delete']
          if(action.param) {
            var filters = action.filters
            if(filters) { // apply filter(s)
              if(typeof filters == 'function') {
                app.delete('/' + resource + '/' + action.param, filters, action.callback);
              } else {
                filters.push(action.callback);
                filters.unshift('/' + resource + '/' + action.param);
                app.delete.apply(app, filters);
                // Remember to append 'scope' before 'filters'
                action.filters = filters.slice(1, filters.length - 1);
              }
            } else { // No filters
              app.delete('/' + resource + '/' + action.param, action.callback);
            }
          }
        }

        // Create aliasMap
        // List all resources
        aliasMap['list_' + resource] =  (function(resource) {
          return function() {
            return '/' + resource;
          }
        })(resource);
        // Display specific resource
        aliasMap['new_' + resource] = (function(resource) {
          return function(id) {
            return '/' + resource + '/new';
          }
        })(resource);
        // Display specific resource
        aliasMap['show_' + resource] = (function(resource) {
          return function(id) {
            return '/' + resource + '/' + id;
          }
        })(resource);
        // Display specific resource
        aliasMap['edit_' + resource] = (function(resource) {
          return function(id) {
            return '/' + resource + '/' + id + '/edit';
          }
        })(resource);
      } else { // Nested resources

      }

    } else{ // Named route via HTTP verbs
      for(var key in map) {
        if(key == 'to') {
          var to = map[key];
        } else if(key == 'as') {
          var alias = map[key];
        } else {
          var method = key;
          var path = map[key];
        }
      }

      // Step 1: register route with method and action above
      // - Load controller:
      var routeFileName = to.substr(0, to.indexOf('#'));
      var action = to.substr(to.indexOf('#') + 1, to.length); // list, new..
      
      controllers = require(routeDir + routeFileName);


      if(controllers[action]) {
        var actionDef = controllers[action],
          filters = actionDef.filters;

        if(filters) { // apply filter(s)
          if(typeof filters == 'function') {
            app[method](path, filters, actionDef.callback);
          } else {
            filters.push(actionDef.callback);
            filters.unshift(path);
            app[method].apply(app, filters);
            // Remember to append 'scope' before 'filters'
            actionDef.filters = filters.slice(1, filters.length - 1);
          }
        } else {
          app[method](path, actionDef.callback);
        }
      }
      // Step 2: create alias
      var listParams = path.match(/:([a-zA-Z_0-9])*/g);
      if(listParams) {
        if(listParams.length > 1) {
          aliasMap[alias] = (function(key, path) {
            return function(paramObj) {
              for(var key in paramObj) {
                path = path.replace(':' + key, paramObj[key]);
              }
              return path;
            }
          })(key, path)
        } else {
          aliasMap[alias] = function(path, listParams) {
            return function(paramStr) {
              return path.replace(listParams[0], paramStr);
            }
          }(path, listParams)
        }
      } else {
        aliasMap[alias] = (function(path) {
          return function() {
            return path;
          }
        })(path);
      }


    }
  }
}

module.exports.get = function(alias, param) {
  if(param) {
    return aliasMap[alias](param);
  } else {
    return aliasMap[alias]();
  }
}